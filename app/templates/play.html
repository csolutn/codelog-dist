{% set id = request.args.get('id', "") %}
{% if id != "" %}
{% extends "nonav.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

{% endblock %}

{% block content %}
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!-- â¶ ID ì…ë ¥ / í™•ì¸                                -->
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
 <div class="row" style="{% if id != "" %}display: none;{% endif %}">
<div class="form-group text-center d-flex align-items-end col-md-6" style="margin-top:-6">
    <label for="mongoIdInput" class="form-label mr-2">id:</label>
    <input type="text" id="mongoIdInput" class="form-control mr-2" placeholder="{{ id }}" value="{{ id }}" {% if id %} disabled {% endif %}>
    <button id="fetchLogBtn" class="btn btn-primary">Confirm</button>
</div>
<div class="form-group text-center col-md-6 mt-4">
    <input type="file" id="fileInput" class="form-control-file" accept=".json">
</div>
</div>
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!-- â· JSON íŒŒì¼ ì—…ë¡œë“œ                              -->
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->


<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!-- â¸ ì¬ìƒ ì»¨íŠ¸ë¡¤ (ë°°ì† Â· ì¼ì‹œì •ì§€)                 -->
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="mt-1 d-flex flex-wrap align-items-center">
    <div class="btn-group mr-2" role="group" aria-label="Speed buttons">
        <button class="btn btn-outline-info btn-sm speed-btn" data-speed="1.0">x1.0</button>
        <button class="btn btn-outline-info btn-sm speed-btn" data-speed="2.0">x2.0</button>
        <button class="btn btn-outline-info btn-sm speed-btn" data-speed="4.0">x4.0</button>
        <button class="btn btn-outline-info btn-sm speed-btn" data-speed="6.0">x6.0</button>
        <button class="btn btn-outline-info btn-sm speed-btn" data-speed="8.0">x8.0</button>
        <button class="btn btn-outline-info btn-sm speed-btn" data-speed="10.0">x10.0</button>
    </div>

    <input type="number" id="customSpeedInput" class="form-control mt-3 mr-2" style="width: 85px;height: 87%;" step="0.1" min="0.1" placeholder="ex. 1.8">
    <button id="setCustomSpeedBtn" class="btn btn-primary btn-sm mr-2">Set</button>

    <button id="pausePlaybackBtn" class="btn btn-outline-warning btn-sm">Pause</button>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!-- â¹ í…ìŠ¤íŠ¸ / ì°¨íŠ¸ ì˜ì—­                           -->
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="row mt-3">
    <div class="col-md-12 col-lg-6 mb-3 mb-lg-0">
        <textarea id="playbackTextarea" class="form-control" style="height: 400px" readonly></textarea>
        <div id="controls" class="text-center mt-3" style="display: none;">
            <button id="startPlaybackBtn" class="btn btn-warning mr-2" disabled>Replay</button>
            <button id="backToCodeBtn" class="btn btn-secondary">Back to Code</button>
        </div>
    </div>

    <div class="col-md-12 col-lg-6" id="chartContainer" style="border: 1px solid #ccc; border-radius: 10px; padding: 10px; height: 420px;"  tabindex="0"  >
        <canvas id="chart"></canvas>
    </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<!-- âº ìŠ¤í¬ë¦½íŠ¸                                    -->
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â–£ ì „ì—­ ë³€ìˆ˜
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let intLogData       = [];   // idxê°€ ì •ìˆ˜ì¸ ì´ë²¤íŠ¸
let charLogData      = [];   // idxê°€ ë¬¸ìì¸ ì´ë²¤íŠ¸
let chartInstance    = null;
let playbackTimeout  = null;
let playbackSpeed    = 1.0;
let currentIdx       = 0;
let isPaused         = false;
let lastMongoId      = "";
let chartStartTimestamp = 0; // ì°¨íŠ¸ ë²”ìœ„ ì‹œì‘ (ms)
let chartEndTimestamp   = 0; // ì°¨íŠ¸ ë²”ìœ„ ë   (ms)
let minContentLength = 0; // ê°€ì¥ ì§§ì€ content ê¸¸ì´
let maxContentLength = 0; // ê°€ì¥ ì§§ì€ content ê¸¸ì´
let animFrameId      = null; // requestAnimationFrame id

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â–£ DOM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const el = id => document.getElementById(id);
const playbackTextarea    = el("playbackTextarea");
const startPlaybackBtn    = el("startPlaybackBtn");
const fileInput           = el("fileInput");
const backToCodeBtn       = el("backToCodeBtn");
const fetchLogBtn         = el("fetchLogBtn");
const mongoIdInput        = el("mongoIdInput");
const pausePlaybackBtn    = el("pausePlaybackBtn");
const customSpeedInput    = el("customSpeedInput");
const setCustomSpeedBtn   = el("setCustomSpeedBtn");


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â–£ ê³µí†µ í•¨ìˆ˜
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cancelAnim() {
    if (animFrameId !== null) {
        cancelAnimationFrame(animFrameId);
        animFrameId = null;
    }
}

function resetAll() {
    clearTimeout(playbackTimeout);
    cancelAnim();
    isPaused = false;
    currentIdx = 0;
    playbackTextarea.value = "";
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }
    startPlaybackBtn.disabled = true;
    pausePlaybackBtn.textContent = "Pause";
}

function getUrlParameter(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â–£ ë°ì´í„° ë¡œë“œ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchLogData(mongoId) {
    try {
        const res = await fetch(`/get_log?id=${mongoId}`);
        if (!res.ok) throw new Error("Log data not found.");
        const data = await res.json();
        handleLoadedLogData(data);
    } catch (e) {
        console.error(e.message);
    } finally {
    }
}

function handleLoadedLogData(raw) {
    if (!Array.isArray(raw) || !raw.length) {
        console.error("Invalid log");
        return;
    }
    resetAll();

    intLogData  = raw.filter(e => Number.isInteger(e.idx));
    charLogData = raw.filter(e => !Number.isInteger(e.idx));

    // â–¸ ì°¨íŠ¸ ë²”ìœ„ ê³„ì‚° (idxê°€ "a" "d" ì œì™¸)
    const relevant = raw.filter(e => !(e.idx === 'a' || e.idx === 'd'));
    chartStartTimestamp = Math.min(...relevant.map(e => e.timestamp));
    chartEndTimestamp   = Math.max(...relevant.map(e => e.timestamp));
    // ì •ìˆ˜ ì¸ë±ìŠ¤ ìµœì†Œ content ê¸¸ì´ ê³„ì‚°
    minContentLength = Math.min(...intLogData.map(e => e.content.length));
    maxContentLength = Math.max(...intLogData.map(e => e.content.length))-minContentLength;
    if (maxContentLength < 5) {
        maxContentLength = 20;
    }

    if (intLogData.length) {
        startPlaybackBtn.disabled = false;
        renderChart();
        startPlaybackFromIndex(0);
    }
}

// íŒŒì¼ ì—…ë¡œë“œ
fileInput.addEventListener('change', ev => {
    const file = ev.target.files[0];
    if (!file || file.type !== 'application/json') {
        return console.error('Invalid file');
    }
    const reader = new FileReader();
    reader.onload = e => {
        loadingSpinnerFile.style.display = "block";
        try {
            handleLoadedLogData(JSON.parse(e.target.result));
        } catch {
            console.error('Parse error');
        } finally {
            loadingSpinnerFile.style.display = "none";
        }
    };
    reader.readAsText(file);
});

// Confirm
fetchLogBtn.addEventListener('click', () => {
    const id = mongoIdInput.value.trim();
    if (!id) {
        return console.error('Invalid _id');
    }
    if (id !== lastMongoId) {
        resetAll();
        lastMongoId = id;
    }
    fetchLogData(id);
});

document.addEventListener('DOMContentLoaded', () => {
    const idParam = getUrlParameter('id');
    if (idParam) {
        mongoIdInput.value = idParam;
        lastMongoId = idParam;
        fetchLogData(idParam);
    }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â–£ ì¬ìƒ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setScatter(x, y) {
    const ds = chartInstance.data.datasets[chartInstance.data.datasets.length - 1];
    ds.data = [{ x, y }];
    chartInstance.update('none');
}

function animateSegment(startEntry, endEntry) {
    cancelAnim();
    if (!endEntry) return;

    const duration = (endEntry.timestamp - startEntry.timestamp) / playbackSpeed;
    const startTime = performance.now();
    const xStart = (startEntry.timestamp - chartStartTimestamp) / 1000;
    const yStart = startEntry.content.length;
    const xEnd = (endEntry.timestamp - chartStartTimestamp) / 1000;
    const yEnd = endEntry.content.length;

    function step() {
        if (isPaused) return;
        const elapsed = performance.now() - startTime;
        let t = elapsed / duration;
        if (t > 1) t = 1;

        const x = xStart + (xEnd - xStart) * t;
        const y = yStart + (yEnd - yStart) * t;
        setScatter(x, y);

        if (t < 1) {
            animFrameId = requestAnimationFrame(step);
        }
    }
    animFrameId = requestAnimationFrame(step);
}

function startPlaybackFromIndex(start) {
    if (!intLogData.length) {
        return;
    }
    currentIdx = start;
    clearTimeout(playbackTimeout);
    cancelAnim();

    const typeNext = () => {
        if (currentIdx >= intLogData.length || isPaused) {
            return;
        }
        const entry = intLogData[currentIdx];
        const nextEntry = intLogData[currentIdx + 1];
        playbackTextarea.value = entry.content;

        playbackTextarea.value = entry.content;
        const interval = nextEntry ? (nextEntry.timestamp - entry.timestamp) / playbackSpeed : 0;
        setScatter((entry.timestamp - chartStartTimestamp) / 1000, entry.content.length);
        animateSegment(entry, nextEntry);
        currentIdx++;
        if (nextEntry) {
            playbackTimeout = setTimeout(typeNext, interval);
        }
    };
    typeNext();
}

startPlaybackBtn.addEventListener('click', () => {
    playbackTextarea.value = '';
    startPlaybackFromIndex(0);
});

backToCodeBtn.addEventListener('click', () => {
    window.location.href = '/';
});

pausePlaybackBtn.addEventListener('click', () => {
    if (!intLogData.length) {
        return;
    }
    if (!isPaused) {
        clearTimeout(playbackTimeout);
        cancelAnim();
        isPaused = true;
        pausePlaybackBtn.textContent = 'Resume';
    } else {
        isPaused = false;
        pausePlaybackBtn.textContent = 'Pause';
        startPlaybackFromIndex(currentIdx);
    }
});

// ë°°ì†
function updatePlaybackSpeed(newSpeed) {
    const currentEntry = intLogData[currentIdx - 1];
    const nextEntry = intLogData[currentIdx];
    playbackSpeed = newSpeed;

    // í˜„ì¬ ì§„í–‰ ì¤‘ì´ë©´ ë‹¤ìŒ interval ì¬ê³„ì‚°
    if (!isPaused && nextEntry) {
        clearTimeout(playbackTimeout);
        cancelAnim();

        const interval = (nextEntry.timestamp - currentEntry.timestamp) / playbackSpeed;
        animateSegment(currentEntry, nextEntry);
        playbackTimeout = setTimeout(() => startPlaybackFromIndex(currentIdx), interval);
    }
}

// ğŸ“Œ speed ë²„íŠ¼ í´ë¦­ â†’ ì¬ìƒì†ë„ ë°˜ì˜ + ì—…ë°ì´íŠ¸
[...document.querySelectorAll('.speed-btn')].forEach(btn => {
    btn.addEventListener('click', function () {
        document.querySelectorAll('.speed-btn').forEach(b => b.classList.replace('btn-info', 'btn-outline-info'));
        this.classList.replace('btn-outline-info', 'btn-info');
        updatePlaybackSpeed(parseFloat(this.dataset.speed));
    });
});

// ğŸ“Œ custom speed ì…ë ¥ â†’ ì¬ìƒì†ë„ ë°˜ì˜ + ì—…ë°ì´íŠ¸
setCustomSpeedBtn.addEventListener('click', () => {
    const val = parseFloat(customSpeedInput.value);
    if (isNaN(val) || val <= 0) return alert('Enter valid speed');
    document.querySelectorAll('.speed-btn').forEach(b => b.classList.replace('btn-info', 'btn-outline-info'));
    updatePlaybackSpeed(val);
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â–£ ì°¨íŠ¸
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


function renderChart() {
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }
    if (!intLogData.length && !charLogData.length) {
        chartInstance = new Chart(el('chart'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: []
            }
        });
        return;
    }

    // ì •ìˆ˜ ì¸ë±ìŠ¤ ìµœì†Œ content ê¸¸ì´ ê³„ì‚°
    minContentLength = Math.min(...intLogData.map(e => e.content.length));

    const typingDataset = {
        label: 'Î” Len',
        type: 'line',
        data: intLogData.map(e => ({
            x: (e.timestamp - chartStartTimestamp) / 1000,
            y: e.content.length - minContentLength
        })),
        borderColor: 'rgba(75,192,192,1)',
        pointBackgroundColor: 'rgba(75,192,192,1)',
        tension: 0
    };

    const colors = {
        v: 'rgba(153,102,255,0.6)',
        a: 'rgba(200,200,200,0.6)',
        d: 'rgba(200,200,200,0.6)',
        o: 'rgba(75,192,75,0.6)',
        e: 'rgba(255,99,132,0.6)',
        u: 'rgba(255,159,64,0.6)',
        s: 'rgba(54,162,235,0.6)'
    };
    const labels = {
        v: 'paste',
        a: 'a',
        d: 'd',
        o: 'o',
        e: 'e',
        u: 'u',
        s: 's'
    };

    const barDatasets = Object.keys(labels).map(k => ({
        label: labels[k],
        type: 'bar',
        data: charLogData
            .filter(e => e.idx === k)
            .map(e => ({
                x: (e.timestamp - chartStartTimestamp) / 1000,
                y: Math.min(e.content.length, maxContentLength)
            })),
        backgroundColor: colors[k],
        barThickness: 5,
        maxBarThickness: 5,
        borderWidth: 0
    }));

    const playbackDataset = {
        label: 'dot',
        data: [],
        type: 'scatter',
        backgroundColor: 'rgba(75,192,192,0.5)',
        pointRadius: 8,
        showLine: false,
    };

    // playbackDatasetë¥¼ ê°€ì¥ ì•ìœ¼ë¡œ ì˜¬ë¦¬ê¸° ìœ„í•´ ë§ˆì§€ë§‰ì— ì¶”ê°€
    chartInstance = new Chart(el('chart'), {
        type: 'scatter',
        data: {
            datasets: [...barDatasets, typingDataset, playbackDataset]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    min: 0,
                    max: (chartEndTimestamp - chartStartTimestamp) / 1000,
                    title: {
                        display: true,
                        text: 'Time Elapsed (s)'
                    },
                    ticks: {
                        callback: v => v.toFixed(0)
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Î” Content Length'
                    }
                }
            },
            plugins: {
                    zoom: {
                    pan: {
                        enabled: true,
                        mode: 'x', // xì¶•ë§Œ ì´ë™ ê°€ëŠ¥
                        modifierKey: null 
                    },
                    zoom: {
                        wheel: {
                            enabled: true,
                            modifierKey: 'alt' // (ì„ íƒ) Alt í‚¤ë¡œ íœ  ì¤Œ í—ˆìš©
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'x', // xì¶•ë§Œ í™•ëŒ€/ì¶•ì†Œ
                        limits: {
                            x: {
                                min: 0, // ìµœì†Œ ì‹œê°„ (ì´ˆ ë‹¨ìœ„)
                                max: (chartEndTimestamp - chartStartTimestamp) / 1000, // ìµœëŒ€ ì‹œê°„
                                minRange: 2 // ìµœì†Œ ì¤Œ ë²”ìœ„ (ì´ˆ ë‹¨ìœ„) â†’ ë„ˆë¬´ í™•ëŒ€ ì•ˆ ë˜ê²Œ
                            }
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: ctx => `t=${ctx.raw.x.toFixed(1)}s, Î”len=${ctx.raw.y}`
                    }
                },
                legend: {
                    labels: {
                        boxWidth: 10,
                        boxHeight: 10
                    }
                },
            },
            onClick: e => {
                const pts = chartInstance.getElementsAtEventForMode(
                    e,
                    'nearest',
                    { intersect: true },
                    true
                );
                if (pts.length) {
                    const newIdx = pts[0].index;
                    currentIdx = newIdx;
                    playbackTextarea.value = intLogData[newIdx].content;
                    setScatter(
                        (intLogData[newIdx].timestamp - chartStartTimestamp) / 1000,
                        intLogData[newIdx].content.length
                    );

                    if (!isPaused) {
                        startPlaybackFromIndex(currentIdx);
                    }
                }
            }
        }
    });
}

// scatter ìœ„ì¹˜ë„ Î” content length ë¡œ ë§ì¶¤
function setScatter(x, y) {
    const ds = chartInstance.data.datasets[chartInstance.data.datasets.length - 1];
    ds.data = [{ x, y: y - minContentLength }];
    chartInstance.update('none');
}

document.addEventListener('keydown', (e) => {
    if (!chartInstance) return;

    const panAmount = 1; // ì´ˆ ë‹¨ìœ„ë¡œ ì´ë™
    const xScale = chartInstance.scales.x;
    let min = xScale.min;
    let max = xScale.max;

    if (e.key === 'ArrowLeft') {
        min -= panAmount;
        max -= panAmount;
    } else if (e.key === 'ArrowRight') {
        min += panAmount;
        max += panAmount;
    } else {
        return; // ìœ„ì•„ë˜ ë“± ë‹¤ë¥¸ í‚¤ëŠ” ë¬´ì‹œ
    }

    // ë²”ìœ„ ì œí•œ
    const maxLimit = (chartEndTimestamp - chartStartTimestamp) / 1000;
    if (min < 0) {
        max += -min;
        min = 0;
    }
    if (max > maxLimit) {
        min -= max - maxLimit;
        max = maxLimit;
    }

    chartInstance.options.scales.x.min = min;
    chartInstance.options.scales.x.max = max;
    chartInstance.update('none');
});
</script>
{% endblock %}

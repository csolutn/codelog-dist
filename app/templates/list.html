<h2 class="mb-4">List Responses by Alias(sheet)</h2>

<!-- Alias 검색 폼 -->
<form id="aliasForm" method="get" autocomplete="off">
    <div class="row mb-4">
        <div class="col-md-6">
            <label for="aliasInput" class="form-label required">{{_('Alias(sheet):')}}</label>
            <input type="text" id="aliasInput" name="alias" class="form-control" required>
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button id="searchButton" type="button" class="btn btn-primary w-100" onclick="fetchProblems()">{{_('Search')}}</button>
        </div>
    </div>
</form>


<!-- 문제 목록 버튼 -->
<div id="problemButtons" class="mb-4"></div>

<!-- Sid 및 이름으로 검색하는 폼 -->
<form id="searchForm" method="get" autocomplete="off" class="mb-4">
    <div class="row">
        <div class="col-md-4">
            <label for="sidInput" class="form-label">{{_('Search by SID:')}}</label>
            <input type="text" id="sidInput" name="sid" class="form-control">
        </div>
        <div class="col-md-4">
            <label for="nameInput" class="form-label">{{_('Search by Name:')}}</label>
            <input type="text" id="nameInput" name="name" class="form-control">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button id="searchButton2" type="button" class="btn btn-primary w-100" onclick="filterTable()">{{_('Search')}}</button>
        </div>
    </div>
</form>

<!-- 테이블 컨테이너 -->
<div id="resultTable" class="table-container mb-4" style="display: none;">
    <table class="table table-striped">
        <thead>
            <tr>
                <th style="width: 8%;">Index</th>
                <th style="width: 12%;">SID</th>
                <th style="width: 10%;">Name</th>
                <th style="width: 40%;">Content</th>
                <th style="width: 20%;">S/U</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            <!-- 데이터는 JavaScript로 동적 로드 -->
        </tbody>
    </table>
</div>

<!-- Bootstrap Modal -->
<div class="modal fade" id="playbackModal" tabindex="-1" aria-labelledby="playbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl"> <!-- modal-xl: 큰 모달 -->
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title" id="playbackModalLabel">Playback</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <iframe id="playbackFrame" src="" style="width: 100%; height: 550px; border: none;"></iframe>
            </div>
        </div>
    </div>
</div>

<script>
    // 비동기 검색 함수
    function fetchProblems() {
        const aliasInput = document.getElementById("aliasInput").value;

        if (!aliasInput) {
            alert("Please enter an alias.");
            return;
        }
       
        fetch(`/get_sheet?alias=${aliasInput}`)
        .then(response => response.json())
        .then(data => {
            const problemButtons = document.getElementById("problemButtons");
            problemButtons.innerHTML = ""; // 기존 버튼 초기화

            // 문제 목록이 포함되어 있는지 확인
            if (data.problem_list && Array.isArray(data.problem_list)) {
                // problem_list 배열에서 각 문제에 대해 버튼 생성
                data.problem_list.forEach(problem => {
                    const button = `
                        <button 
                            class="btn btn-outline-info problem-btn" 
                            onclick="loadTable('${problem}')">
                            ${problem}
                        </button>`;
                    problemButtons.insertAdjacentHTML("beforeend", button);
                });
            } else {
                problemButtons.innerHTML = `<p>No problems found for the given alias.</p>`;
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    }

    function loadTable(problem_alias) {
        const aliasInput = document.getElementById("aliasInput").value;
        const tableBody = document.getElementById("tableBody");
        tableBody.innerHTML = "";

        fetch(`/get_responses?alias=${aliasInput}&problem_alias=${problem_alias}`)
        .then(response => response.json())
        .then(data => {
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center">{{_('No data available')}}</td></tr>`;
            } else {
                const reversedData = data.reverse();
                reversedData.forEach((item, index) => {
                    const timestamp = item.timestamp
                        ? new Date(item.timestamp).toLocaleString("ko-KR", {
                            timeZone: "Asia/Seoul",
                            year: "numeric",
                            month: "2-digit",
                            day: "2-digit",
                            hour: "2-digit",
                            minute: "2-digit",
                            hour12: false
                        })
                        : "";

                    const row = `
                        <tr>
                            <td>
                                ${reversedData.length - index}
                                <br>
                                <small style="font-size: 11px; color: #6c757d;">${timestamp}</small>
                            </td>
                            <td>${item.sid}</td>
                            <td>${item.name}</td>
                            <td class="content-cell"><pre>${item.content}</pre></td>
                            <td>
                                ${item.success === "true" 
                                    ? '<span style="color: #198754; font-weight: bold;">&#10004;</span>' 
                                    : '<span style="color: #dc3545; font-weight: bold;">✗</span>'}
                                <br>
                                <button class="btn btn-sm btn-outline-primary" onclick="openPlayback('${item._id}')">
                                    ▶log
                                </button>
                                ${item.success === "false" && item.output ? 
                                    `<div class="mt-2" style="white-space: pre-line;font-size:11px" id="output-${item._id}">${item.output}</div>` 
                                    : ''}
                            </td>
                        </tr>`;
                    tableBody.insertAdjacentHTML("beforeend", row);
                });

            }
            document.getElementById("resultTable").style.display = "block";
        })
        .catch(error => {
            console.error("Error loading table data:", error);
        });
        // 버튼 상태 초기화 및 선택한 버튼 활성화
        const buttons = document.querySelectorAll('.problem-btn');
        buttons.forEach(btn => {
            btn.classList.remove('btn-info');
            btn.classList.add('btn-outline-info');
        });

        const currentButton = Array.from(buttons).find(btn => btn.textContent.trim() === problem_alias);
        if (currentButton) {
            currentButton.classList.remove('btn-outline-info');
            currentButton.classList.add('btn-info');
        }
    }

    // SID와 이름으로 필터링 함수
    function filterTable() {
        const sidInput = document.getElementById("sidInput").value.toLowerCase();
        const nameInput = document.getElementById("nameInput").value.toLowerCase();
        const rows = document.querySelectorAll("#tableBody tr");

        rows.forEach(row => {
            const sid = row.cells[0].textContent.toLowerCase();
            const name = row.cells[2].textContent.toLowerCase();

            if (
                (sid.includes(sidInput) || sidInput === "") &&
                (name.includes(nameInput) || nameInput === "")
            ) {
                row.style.display = ""; // 필터 조건에 맞으면 표시
            } else {
                row.style.display = "none"; // 조건에 맞지 않으면 숨김
            }
        });
    }

    // Playback 버튼 클릭 시 모달 열기
    function openPlayback(logId) {
        if (logId) {
            // Iframe에 URL 삽입
            document.getElementById("playbackFrame").src = `/play?id=${logId}`;
            
            // Bootstrap 모달 열기
            let playbackModal = new bootstrap.Modal(document.getElementById("playbackModal"));
            playbackModal.show();
        } else {
            console.error("Invalid log ID for playback.");
        }
    }
</script>

<style>
    /* 테이블 스타일 */
    table {
        table-layout: fixed; /* 고정 테이블 레이아웃 */
        width: 100%; /* 전체 너비 */
    }

    /* 특정 열 스타일 (content 열) */
    .content-cell {
        width: 40%;
        max-width: 500px; /* 최대 너비 */
        word-wrap: break-word; /* 단어 줄바꿈 */
        overflow: auto; /* 넘치는 경우 스크롤바 */
    }
</style>
